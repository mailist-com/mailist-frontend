<main class="p-6">
  <app-page-title
    [title]="isEditMode ? 'Edytuj kampanię' : 'Nowa kampania'"
    [subtitle]="isEditMode ? 'Wprowadź zmiany w kampanii' : 'Utwórz nową kampanię email marketingową'" />

  <!-- Step Indicator -->
  <div class="card p-6 mb-6">
    <div class="flex items-center justify-between">
      <div *ngFor="let step of [1, 2, 3, 4, 5]" class="flex items-center" [class.flex-1]="step < 5">
        <div class="flex items-center">
          <button
            type="button"
            (click)="goToStep(step)"
            class="w-10 h-10 rounded-full flex items-center justify-center text-sm font-medium transition-colors"
            [ngClass]="{
              'bg-primary text-white': step === currentStep,
              'bg-success text-white': step < currentStep && isStepComplete(step),
              'bg-default-100 text-default-600': step > currentStep || (step < currentStep && !isStepComplete(step))
            }">
            <ng-icon *ngIf="step < currentStep && isStepComplete(step)" name="lucideCheck" class="size-5"></ng-icon>
            <span *ngIf="step >= currentStep || !isStepComplete(step)">{{ step }}</span>
          </button>
          <div class="ms-3 text-left">
            <div class="text-sm font-medium text-default-900">{{ getStepTitle(step) }}</div>
          </div>
        </div>
        <div *ngIf="step < 5" class="flex-1 h-px bg-default-200 mx-4"></div>
      </div>
    </div>
  </div>

  <!-- Form Content -->
  <form #campaignFormElement="ngForm" (ngSubmit)="saveCampaign()">
    <!-- Step 1: Basic Information -->
    <div *ngIf="currentStep === 1" class="card p-6">
      <h3 class="text-lg font-semibold text-default-900 mb-6">Informacje podstawowe</h3>

      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-default-700 mb-2">
            Nazwa kampanii <span class="text-danger">*</span>
          </label>
          <input
            type="text"
            [(ngModel)]="campaign.name"
            name="name"
            required
            class="form-input w-full"
            placeholder="np. Newsletter Listopad 2024">
        </div>

        <div>
          <label class="block text-sm font-medium text-default-700 mb-2">
            Temat wiadomości <span class="text-danger">*</span>
          </label>
          <input
            type="text"
            [(ngModel)]="campaign.subject"
            name="subject"
            required
            class="form-input w-full"
            placeholder="np. Najnowsze trendy w marketingu emailowym">
        </div>

        <div>
          <label class="block text-sm font-medium text-default-700 mb-2">
            Preheader
          </label>
          <input
            type="text"
            [(ngModel)]="campaign.preheader"
            name="preheader"
            class="form-input w-full"
            placeholder="Krótki tekst widoczny obok tematu">
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-default-700 mb-2">
              Imię nadawcy <span class="text-danger">*</span>
            </label>
            <input
              type="text"
              [(ngModel)]="campaign.fromName"
              name="fromName"
              required
              class="form-input w-full"
              placeholder="np. Zespół Mailist">
          </div>

          <div>
            <label class="block text-sm font-medium text-default-700 mb-2">
              Email nadawcy <span class="text-danger">*</span>
            </label>
            <input
              type="email"
              [(ngModel)]="campaign.fromEmail"
              name="fromEmail"
              required
              class="form-input w-full"
              placeholder="newsletter@example.com">
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium text-default-700 mb-2">
            Email odpowiedzi (Reply-To)
          </label>
          <input
            type="email"
            [(ngModel)]="campaign.replyTo"
            name="replyTo"
            class="form-input w-full"
            placeholder="kontakt@example.com">
        </div>

        <div>
          <label class="block text-sm font-medium text-default-700 mb-2">
            Typ kampanii
          </label>
          <select
            [(ngModel)]="campaign.type"
            name="type"
            class="form-input w-full">
            <option value="regular">Standardowa</option>
            <option value="ab_test">Test A/B</option>
            <option value="rss">RSS</option>
            <option value="automated">Automatyczna</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Step 2: Recipients -->
    <div *ngIf="currentStep === 2" class="card p-6">
      <h3 class="text-lg font-semibold text-default-900 mb-6">Odbiorcy</h3>

      <div class="space-y-6">
        <div>
          <label class="block text-sm font-medium text-default-700 mb-3">
            Wybierz odbiorców
          </label>
          <div class="space-y-2">
            <label class="flex items-center">
              <input
                type="radio"
                [(ngModel)]="campaign.recipients!.type"
                name="recipientType"
                value="all"
                class="form-radio text-primary">
              <span class="ms-2 text-sm text-default-700">Wszyscy subskrybenci</span>
            </label>
            <label class="flex items-center">
              <input
                type="radio"
                [(ngModel)]="campaign.recipients!.type"
                name="recipientType"
                value="lists"
                class="form-radio text-primary">
              <span class="ms-2 text-sm text-default-700">Określone listy</span>
            </label>
            <label class="flex items-center">
              <input
                type="radio"
                [(ngModel)]="campaign.recipients!.type"
                name="recipientType"
                value="segments"
                class="form-radio text-primary">
              <span class="ms-2 text-sm text-default-700">Segmenty</span>
            </label>
            <label class="flex items-center">
              <input
                type="radio"
                [(ngModel)]="campaign.recipients!.type"
                name="recipientType"
                value="tags"
                class="form-radio text-primary">
              <span class="ms-2 text-sm text-default-700">Tagi</span>
            </label>
          </div>
        </div>

        <!-- Lists Selection -->
        <div *ngIf="campaign.recipients!.type === 'lists'" class="border border-default-200 rounded-lg p-4">
          <h4 class="text-sm font-medium text-default-900 mb-3">Wybierz listy</h4>
          <div class="space-y-2">
            <label class="flex items-center p-3 rounded-lg hover:bg-default-50 transition-colors">
              <input type="checkbox" class="form-checkbox text-primary" value="list-1">
              <span class="ms-3">
                <div class="text-sm font-medium text-default-900">Newsletter główny</div>
                <div class="text-xs text-default-600">2,543 subskrybentów</div>
              </span>
            </label>
            <label class="flex items-center p-3 rounded-lg hover:bg-default-50 transition-colors">
              <input type="checkbox" class="form-checkbox text-primary" value="list-2">
              <span class="ms-3">
                <div class="text-sm font-medium text-default-900">Klienci VIP</div>
                <div class="text-xs text-default-600">1,234 subskrybentów</div>
              </span>
            </label>
            <label class="flex items-center p-3 rounded-lg hover:bg-default-50 transition-colors">
              <input type="checkbox" class="form-checkbox text-primary" value="list-3">
              <span class="ms-3">
                <div class="text-sm font-medium text-default-900">Blog subscribers</div>
                <div class="text-xs text-default-600">987 subskrybentów</div>
              </span>
            </label>
          </div>
        </div>

        <!-- Segments Selection -->
        <div *ngIf="campaign.recipients!.type === 'segments'" class="border border-default-200 rounded-lg p-4">
          <h4 class="text-sm font-medium text-default-900 mb-3">Wybierz segmenty</h4>
          <div class="space-y-2">
            <label class="flex items-center p-3 rounded-lg hover:bg-default-50 transition-colors">
              <input type="checkbox" class="form-checkbox text-primary" value="segment-1">
              <span class="ms-3">
                <div class="text-sm font-medium text-default-900">Aktywni użytkownicy</div>
                <div class="text-xs text-default-600">4,231 odbiorców</div>
              </span>
            </label>
            <label class="flex items-center p-3 rounded-lg hover:bg-default-50 transition-colors">
              <input type="checkbox" class="form-checkbox text-primary" value="segment-2">
              <span class="ms-3">
                <div class="text-sm font-medium text-default-900">Nowi subskrybenci (ostatnie 30 dni)</div>
                <div class="text-xs text-default-600">567 odbiorców</div>
              </span>
            </label>
            <label class="flex items-center p-3 rounded-lg hover:bg-default-50 transition-colors">
              <input type="checkbox" class="form-checkbox text-primary" value="segment-3">
              <span class="ms-3">
                <div class="text-sm font-medium text-default-900">Nieaktywni od 3 miesięcy</div>
                <div class="text-xs text-default-600">1,892 odbiorców</div>
              </span>
            </label>
          </div>
        </div>

        <!-- Tags Selection -->
        <div *ngIf="campaign.recipients!.type === 'tags'" class="border border-default-200 rounded-lg p-4">
          <h4 class="text-sm font-medium text-default-900 mb-3">Wybierz tagi</h4>
          <div class="space-y-2">
            <label class="flex items-center p-3 rounded-lg hover:bg-default-50 transition-colors">
              <input type="checkbox" class="form-checkbox text-primary" value="tag-1">
              <span class="ms-3">
                <div class="text-sm font-medium text-default-900">Zainteresowani webinarami</div>
                <div class="text-xs text-default-600">1,234 odbiorców</div>
              </span>
            </label>
            <label class="flex items-center p-3 rounded-lg hover:bg-default-50 transition-colors">
              <input type="checkbox" class="form-checkbox text-primary" value="tag-2">
              <span class="ms-3">
                <div class="text-sm font-medium text-default-900">E-commerce</div>
                <div class="text-xs text-default-600">2,345 odbiorców</div>
              </span>
            </label>
            <label class="flex items-center p-3 rounded-lg hover:bg-default-50 transition-colors">
              <input type="checkbox" class="form-checkbox text-primary" value="tag-3">
              <span class="ms-3">
                <div class="text-sm font-medium text-default-900">Premium</div>
                <div class="text-xs text-default-600">678 odbiorców</div>
              </span>
            </label>
          </div>
        </div>

        <!-- Total Count Display -->
        <div class="bg-primary/5 border border-primary/20 rounded-lg p-4">
          <div class="flex items-center justify-between">
            <span class="text-sm text-default-700">Szacowana liczba odbiorców:</span>
            <span class="text-lg font-semibold text-primary">{{ campaign.recipients!.totalCount || 0 }}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Step 3: Content -->
    <div *ngIf="currentStep === 3" class="card p-6">
      <h3 class="text-lg font-semibold text-default-900 mb-6">Treść wiadomości</h3>

      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-default-700 mb-2">
            Treść HTML <span class="text-danger">*</span>
          </label>
          <textarea
            [(ngModel)]="campaign.content!.html"
            name="htmlContent"
            required
            rows="15"
            class="form-input w-full font-mono text-sm"
            placeholder="<html>&#10;  <body>&#10;    <h1>Witaj!</h1>&#10;    <p>Treść twojej wiadomości...</p>&#10;  </body>&#10;</html>"></textarea>
          <p class="mt-1 text-xs text-default-600">Wklej pełny kod HTML swojej wiadomości email</p>
        </div>

        <div>
          <label class="block text-sm font-medium text-default-700 mb-2">
            Wersja tekstowa
          </label>
          <textarea
            [(ngModel)]="campaign.content!.text"
            name="textContent"
            rows="8"
            class="form-input w-full"
            placeholder="Treść wiadomości w formacie tekstowym..."></textarea>
          <p class="mt-1 text-xs text-default-600">Opcjonalna wersja tekstowa dla klientów email niepodporujących HTML</p>
        </div>

        <!-- Settings -->
        <div class="border-t border-default-200 pt-4 mt-6">
          <h4 class="text-sm font-medium text-default-900 mb-3">Ustawienia śledzenia</h4>
          <div class="space-y-2">
            <label class="flex items-center">
              <input
                type="checkbox"
                [(ngModel)]="campaign.settings!.trackOpens"
                name="trackOpens"
                class="form-checkbox text-primary">
              <span class="ms-2 text-sm text-default-700">Śledź otwarcia</span>
            </label>
            <label class="flex items-center">
              <input
                type="checkbox"
                [(ngModel)]="campaign.settings!.trackClicks"
                name="trackClicks"
                class="form-checkbox text-primary">
              <span class="ms-2 text-sm text-default-700">Śledź kliknięcia</span>
            </label>
            <label class="flex items-center">
              <input
                type="checkbox"
                [(ngModel)]="campaign.settings!.googleAnalytics!.enabled"
                name="gaEnabled"
                class="form-checkbox text-primary">
              <span class="ms-2 text-sm text-default-700">Integracja z Google Analytics</span>
            </label>
          </div>
        </div>
      </div>
    </div>

    <!-- Step 4: Schedule -->
    <div *ngIf="currentStep === 4" class="card p-6">
      <h3 class="text-lg font-semibold text-default-900 mb-6">Planowanie wysyłki</h3>

      <div class="space-y-6">
        <div>
          <label class="block text-sm font-medium text-default-700 mb-3">
            Kiedy wysłać kampanię?
          </label>
          <div class="space-y-3">
            <label class="flex items-start p-4 border border-default-200 rounded-lg hover:border-primary transition-colors cursor-pointer">
              <input
                type="radio"
                [(ngModel)]="scheduleType"
                name="scheduleType"
                value="immediate"
                class="form-radio text-primary mt-1">
              <div class="ms-3">
                <div class="text-sm font-medium text-default-900">Wyślij natychmiast</div>
                <div class="text-xs text-default-600">Kampania zostanie wysłana zaraz po zapisaniu</div>
              </div>
            </label>
            <label class="flex items-start p-4 border border-default-200 rounded-lg hover:border-primary transition-colors cursor-pointer">
              <input
                type="radio"
                [(ngModel)]="scheduleType"
                name="scheduleType"
                value="scheduled"
                class="form-radio text-primary mt-1">
              <div class="ms-3">
                <div class="text-sm font-medium text-default-900">Zaplanuj na później</div>
                <div class="text-xs text-default-600">Wybierz datę i godzinę wysyłki</div>
              </div>
            </label>
          </div>
        </div>

        <!-- Scheduled Date/Time -->
        <div *ngIf="scheduleType === 'scheduled'" class="border border-default-200 rounded-lg p-4">
          <h4 class="text-sm font-medium text-default-900 mb-4">Data i godzina wysyłki</h4>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-default-700 mb-2">Data</label>
              <input
                type="date"
                [(ngModel)]="scheduledDate"
                name="scheduledDate"
                class="form-input w-full">
            </div>
            <div>
              <label class="block text-sm font-medium text-default-700 mb-2">Godzina</label>
              <input
                type="time"
                [(ngModel)]="scheduledTime"
                name="scheduledTime"
                class="form-input w-full">
            </div>
          </div>
          <p class="mt-2 text-xs text-default-600">Strefa czasowa: Europe/Warsaw (CET/CEST)</p>
        </div>

        <!-- Info Box -->
        <div class="bg-info/5 border border-info/20 rounded-lg p-4">
          <div class="flex items-start gap-3">
            <div class="size-5 text-info mt-0.5">
              <ng-icon name="lucideInfo"></ng-icon>
            </div>
            <div class="text-sm text-default-700">
              <p class="font-medium mb-1">Wskazówka:</p>
              <p>Najlepszy czas wysyłki to wtorek-czwartek między 9:00 a 11:00 lub 14:00 a 16:00.</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Step 5: Summary -->
    <div *ngIf="currentStep === 5" class="card p-6">
      <h3 class="text-lg font-semibold text-default-900 mb-6">Podsumowanie</h3>

      <div class="space-y-6">
        <!-- Basic Info -->
        <div>
          <h4 class="text-sm font-medium text-default-900 mb-3">Informacje podstawowe</h4>
          <div class="bg-default-50 rounded-lg p-4 space-y-2">
            <div class="flex justify-between">
              <span class="text-sm text-default-600">Nazwa kampanii:</span>
              <span class="text-sm font-medium text-default-900">{{ campaign.name }}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-sm text-default-600">Temat:</span>
              <span class="text-sm font-medium text-default-900">{{ campaign.subject }}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-sm text-default-600">Od:</span>
              <span class="text-sm font-medium text-default-900">{{ campaign.fromName }} &lt;{{ campaign.fromEmail }}&gt;</span>
            </div>
            <div class="flex justify-between" *ngIf="campaign.replyTo">
              <span class="text-sm text-default-600">Odpowiedz do:</span>
              <span class="text-sm font-medium text-default-900">{{ campaign.replyTo }}</span>
            </div>
          </div>
        </div>

        <!-- Recipients -->
        <div>
          <h4 class="text-sm font-medium text-default-900 mb-3">Odbiorcy</h4>
          <div class="bg-default-50 rounded-lg p-4">
            <div class="flex justify-between items-center">
              <span class="text-sm text-default-600">Liczba odbiorców:</span>
              <span class="text-lg font-semibold text-primary">{{ campaign.recipients!.totalCount || 0 }}</span>
            </div>
          </div>
        </div>

        <!-- Content -->
        <div>
          <h4 class="text-sm font-medium text-default-900 mb-3">Treść</h4>
          <div class="bg-default-50 rounded-lg p-4 space-y-2">
            <div class="flex justify-between">
              <span class="text-sm text-default-600">Treść HTML:</span>
              <span class="text-sm font-medium text-success">
                {{ campaign.content!.html ? 'Dodana' : 'Brak' }}
              </span>
            </div>
            <div class="flex justify-between">
              <span class="text-sm text-default-600">Wersja tekstowa:</span>
              <span class="text-sm font-medium" [class.text-success]="campaign.content!.text" [class.text-default-500]="!campaign.content!.text">
                {{ campaign.content!.text ? 'Dodana' : 'Brak' }}
              </span>
            </div>
          </div>
        </div>

        <!-- Schedule -->
        <div>
          <h4 class="text-sm font-medium text-default-900 mb-3">Harmonogram</h4>
          <div class="bg-default-50 rounded-lg p-4">
            <div class="flex justify-between">
              <span class="text-sm text-default-600">Wysyłka:</span>
              <span class="text-sm font-medium text-default-900">
                <span *ngIf="scheduleType === 'immediate'">Natychmiast po zapisaniu</span>
                <span *ngIf="scheduleType === 'scheduled'">{{ scheduledDate }} {{ scheduledTime }}</span>
              </span>
            </div>
          </div>
        </div>

        <!-- Warning -->
        <div class="bg-warning/5 border border-warning/20 rounded-lg p-4">
          <div class="flex items-start gap-3">
            <div class="size-5 text-warning mt-0.5">
              <ng-icon name="lucideTriangleAlert"></ng-icon>
            </div>
            <div class="text-sm text-default-700">
              <p class="font-medium mb-1">Uwaga!</p>
              <p *ngIf="scheduleType === 'immediate'">
                Po zapisaniu kampania zostanie wysłana natychmiast do wszystkich odbiorców. Upewnij się, że wszystkie dane są prawidłowe.
              </p>
              <p *ngIf="scheduleType === 'scheduled'">
                Kampania zostanie automatycznie wysłana w zaplanowanym terminie. Możesz edytować lub anulować kampanię przed datą wysyłki.
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Navigation Buttons -->
    <div class="mt-6 flex items-center justify-between">
      <div>
        <button
          *ngIf="currentStep > 1"
          type="button"
          (click)="previousStep()"
          class="btn bg-default-100 text-default-600 hover:bg-default-200">
          <div class="size-4 me-1"><ng-icon name="lucideArrowLeft"></ng-icon></div>
          Wstecz
        </button>
      </div>

      <div class="flex items-center gap-3">
        <button
          type="button"
          (click)="cancel()"
          class="btn bg-transparent border border-default-300 text-default-700 hover:bg-default-50">
          Anuluj
        </button>

        <button
          *ngIf="currentStep < totalSteps"
          type="button"
          (click)="nextStep()"
          class="btn bg-primary text-white hover:bg-primary/90">
          Dalej
          <div class="size-4 ms-1"><ng-icon name="lucideArrowRight"></ng-icon></div>
        </button>

        <button
          *ngIf="currentStep === totalSteps"
          type="submit"
          [disabled]="isSaving || !isStepComplete(5)"
          class="btn bg-success text-white hover:bg-success/90 disabled:opacity-50 disabled:cursor-not-allowed">
          <div class="size-4 me-1"><ng-icon name="lucideSave"></ng-icon></div>
          {{ isSaving ? 'Zapisywanie...' : (scheduleType === 'immediate' ? 'Zapisz i wyślij' : 'Zaplanuj wysyłkę') }}
        </button>
      </div>
    </div>
  </form>
</main>
