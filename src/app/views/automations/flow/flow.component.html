<main class="p-6">
  <app-page-title title="Kreator Automatyzacji" subtitle="Twórz i edytuj automatyzacje marketingowe" />

  @if (viewModel(); as model) {
    <div class="bg-white border border-default-200 rounded-lg">
      <!-- Card Header -->
      <div class="px-6 py-4 border-b border-default-200">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-semibold text-default-900">{{ model.name || 'Nowa automatyzacja' }}</h2>
          <div class="flex items-center gap-3">
            <button class="btn btn-sm bg-default-100 text-default-600 hover:bg-default-200">
              <div class="size-4 me-1"><ng-icon name="lucideX"></ng-icon></div>
              Anuluj
            </button>
            <button class="btn btn-sm bg-primary text-white hover:bg-primary/90">
              <div class="size-4 me-1"><ng-icon name="lucideSave"></ng-icon></div>
              Zapisz i zamknij
            </button>
          </div>
        </div>
      </div>

      <!-- Toolbar -->
      <div class="px-6 py-3 border-b border-default-200 bg-default-50/50">
        <app-flow-action-panel [viewModel]="model" (processAction)="processAction($event)" (resetFlow)="reset()"/>
      </div>

      <!-- Main Content -->
      <div class="flex overflow-hidden" style="height: 70vh;">
        <!-- Left Sidebar (Node Library) -->
        <div class="flow-sidebar-left border-e border-default-200 overflow-y-auto" [class.w-80]="!isLeftSidebarMinimized()" [class.w-16]="isLeftSidebarMinimized()" style="transition: width 0.2s ease;">
          <div class="p-4">
            @if (isLeftSidebarMinimized()) {
              <button class="btn btn-sm w-full justify-center" (click)="isLeftSidebarMinimized.set(false)" title="Rozwiń panel">
                <ng-icon name="lucidePanelRight"></ng-icon>
              </button>
            } @else {
              <div class="flex items-center justify-between mb-3">
                <h3 class="text-sm font-semibold text-default-900">Elementy</h3>
                <button class="btn btn-sm btn-ghost" (click)="isLeftSidebarMinimized.set(true)" title="Zwiń panel">
                  <ng-icon name="lucidePanelLeft"></ng-icon>
                </button>
              </div>
              <div class="relative">
                <input type="search" placeholder="Szukaj elementów..." class="form-input form-input-sm ps-9 w-full"/>
                <div class="absolute inset-y-0 start-0 flex items-center ps-3">
                  <div class="size-4 text-default-500"><ng-icon name="lucideSearch"></ng-icon></div>
                </div>
              </div>
            }
          </div>
          <div class="px-4 pb-4">
            <app-flow-palette [viewModel]="model" [isMinimized]="isLeftSidebarMinimized()"/>
          </div>
        </div>

        <!-- Center (Canvas) -->
        <div class="flex-1 relative bg-default-50">
          <f-flow fDraggable
                  (fLoaded)="editorLoaded()"
                  (fMoveNodes)="moveNodes($event)"
                  (fCreateConnection)="createConnection($event)"
                  (fReassignConnection)="reassignConnection($event)"
                  (fCreateNode)="createNode($event)"
                  (fSelectionChange)="changeSelection($event)">
            <f-background>
              <f-circle-pattern/>
            </f-background>
            <f-line-alignment [fAlignThreshold]="20"/>
            <f-selection-area/>
            <f-canvas fZoom
                      [scale]="model.transform?.scale"
                      [position]="model.transform?.position"
                      [debounceTime]="fCanvasChangeEventDebounce"
                      (fCanvasChange)="changeCanvasTransform($event)">
              @for (connection of connections(); track connection.id) {
                <f-connection fBehavior="fixed"
                              [fConnectionId]="connection.id"
                              [fOffset]="32"
                              fType="segment"
                              [fOutputId]="connection.source"
                              [fInputId]="connection.target">
                  <svg id="normal_end" viewBox="0 0 700 700" fMarker [type]="eMarkerType.END" [height]="5" [width]="5"
                       [refX]="4" [refY]="2.5">
                    <path d="M0,0L700,350L0,700L150,350z"/>
                  </svg>
                  <svg id="selected_end" viewBox="0 0 700 700" fMarker [type]="eMarkerType.SELECTED_END" [height]="5"
                       [width]="5" [refX]="4" [refY]="2.5">
                    <path d="M0,0L700,350L0,700L150,350z"/>
                  </svg>
                </f-connection>
              }
              <f-connection-for-create fType="segment" [fOffset]="32">
                <svg id="normal_end" viewBox="0 0 700 700" fMarker [type]="eMarkerType.END" [height]="5" [width]="5" [refX]="4"
                     [refY]="2.5">
                  <path d="M0,0L700,350L0,700L150,350z"/>
                </svg>
              </f-connection-for-create>
              @for (node of nodes(); track node.id) {
                <app-flow-node fNode
                           [fNodeId]="node.id"
                           [viewModel]="node"
                           fNodeInput [fInputId]="node.input"
                           [fInputDisabled]="!node.input"
                           fInputConnectableSide="top"
                           [fNodePosition]="node.position"
                           (removeConnection)="removeConnection($event)">
                </app-flow-node>
              }
            </f-canvas>
          </f-flow>
        </div>

        <!-- Right Sidebar (Settings) -->
        @if (selectedNode(); as node) {
          <div class="w-96 border-s border-default-200 overflow-y-auto bg-white">
            <div class="px-4 py-3 border-b border-default-200 flex justify-between items-center bg-default-50/50">
              <h3 class="text-sm font-semibold text-default-900">Ustawienia elementu</h3>
              <button class="btn btn-sm btn-ghost" (click)="closeSettings()" title="Zamknij">
                <ng-icon name="lucideX"></ng-icon>
              </button>
            </div>
            <div class="p-4">
              <app-flow-node-settings [node]="node"/>
            </div>
          </div>
        }
      </div>
    </div>
  }
</main>
