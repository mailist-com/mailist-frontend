<main>
  <app-page-title
    [title]="(isEditing ? 'COMMON.EDIT' : 'LISTS.CREATE_LIST') | translate"
    [subtitle]="(isEditing ? 'LISTS.SUBTITLE' : 'LISTS.SUBTITLE') | translate" />

  <!-- Error Message -->
  <div *ngIf="error" class="mb-6 p-4 bg-danger/10 border border-danger/20 rounded-lg">
    <div class="flex items-start gap-3">
      <div class="size-5 text-danger mt-0.5"><ng-icon name="lucideAlertCircle"></ng-icon></div>
      <div class="flex-1">
        <h6 class="font-semibold text-danger mb-1">{{ 'COMMON.ERROR' | translate }}</h6>
        <p class="text-sm text-danger/80">{{ error }}</p>
        <button type="button" (click)="error = null" class="btn btn-sm bg-danger/10 text-danger hover:bg-danger hover:text-white mt-3">
          <div class="size-4 me-1"><ng-icon name="lucideX"></ng-icon></div>
          {{ 'COMMON.CLOSE' | translate }}
        </button>
      </div>
    </div>
  </div>

  <form [formGroup]="listForm" (ngSubmit)="onSubmit()">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Main Content -->
      <div class="lg:col-span-2 space-y-6">
        <!-- Basic Information -->
        <div class="card">
          <div class="card-header">
            <h6 class="card-title">{{ 'COMMON.BASIC_INFO' | translate }}</h6>
            <div class="flex items-center gap-3">
              <button type="button" (click)="onCancel()" class="btn btn-sm bg-default-100 text-default-600">
                {{ 'COMMON.CANCEL' | translate }}
              </button>
              <button type="submit" 
                      [disabled]="isLoading || listForm.invalid" 
                      class="btn btn-sm bg-primary text-white">
                <div *ngIf="isLoading" class="size-4 me-1 animate-spin">
                  <ng-icon name="lucideLoader"></ng-icon>
                </div>
                <div *ngIf="!isLoading" class="size-4 me-1">
                  <ng-icon name="lucideSave"></ng-icon>
                </div>
                {{ (isEditing ? 'COMMON.SAVE' : 'LISTS.CREATE_LIST') | translate }}
              </button>
            </div>
          </div>

          <div class="card-body space-y-6">
            <div>
              <label class="block text-sm font-medium text-default-700 mb-2">
                {{ 'LISTS.COLUMN.NAME' | translate }} <span class="text-danger">*</span>
              </label>
              <input type="text" 
                     formControlName="name" 
                     class="form-input"
                     placeholder="e.g., Newsletter Subscribers"
                     [class.border-danger]="listForm.get('name')?.invalid && listForm.get('name')?.touched">
              <div *ngIf="getFieldError('name')" class="text-sm text-danger mt-1">
                {{ getFieldError('name') }}
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-default-700 mb-2">{{ 'COMMON.DESCRIPTION' | translate }}</label>
              <textarea formControlName="description" 
                        rows="3" 
                        class="form-input"
                        placeholder="Describe the purpose of this list..."></textarea>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-default-700 mb-2">
                  {{ 'LISTS.COLUMN.TYPE' | translate }} <span class="text-danger">*</span>
                </label>
                <select formControlName="type" class="form-input">
                  <option *ngFor="let type of listTypes" [value]="type.value">
                    {{ type.label }}
                  </option>
                </select>
                <p class="text-xs text-default-500 mt-1">{{ getTypeDescription(listForm.get('type')?.value) }}</p>
              </div>

              <div>
                <label class="block text-sm font-medium text-default-700 mb-2">{{ 'COMMON.STATUS' | translate }}</label>
                <select formControlName="status" class="form-input">
                  <option *ngFor="let status of listStatuses" [value]="status.value">
                    {{ status.label }}
                  </option>
                </select>
              </div>
            </div>
          </div>
        </div>

        <!-- List Settings -->
        <div class="card" formGroupName="settings">
          <div class="card-header">
            <h6 class="card-title">{{ 'COMMON.SETTINGS' | translate }}</h6>
          </div>
          <div class="card-body space-y-6">
            <!-- Subscription Settings -->
            <div>
              <h6 class="font-medium text-default-700 mb-4">{{ 'COMMON.SETTINGS' | translate }}</h6>
              <div class="space-y-4">
                <div class="flex items-center">
                  <input type="checkbox" 
                         id="doubleOptIn" 
                         formControlName="doubleOptIn" 
                         class="form-checkbox me-3">
                  <label for="doubleOptIn" class="text-sm text-default-700">
                    Enable Double Opt-in
                    <p class="text-xs text-default-500">Require email confirmation before adding to list</p>
                  </label>
                </div>

                <div class="flex items-center">
                  <input type="checkbox" 
                         id="allowPublicSubscription" 
                         formControlName="allowPublicSubscription" 
                         class="form-checkbox me-3">
                  <label for="allowPublicSubscription" class="text-sm text-default-700">
                    Allow Public Subscription
                    <p class="text-xs text-default-500">Enable public signup form for this list</p>
                  </label>
                </div>

                <div class="flex items-center">
                  <input type="checkbox" 
                         id="requireConfirmation" 
                         formControlName="requireConfirmation" 
                         class="form-checkbox me-3">
                  <label for="requireConfirmation" class="text-sm text-default-700">
                    Require Confirmation
                    <p class="text-xs text-default-500">Send confirmation email for subscriptions</p>
                  </label>
                </div>
              </div>
            </div>

            <!-- Welcome Email Settings -->
            <div>
              <h6 class="font-medium text-default-700 mb-4">Welcome Email</h6>
              <div class="space-y-4">
                <div class="flex items-center">
                  <input type="checkbox" 
                         id="sendWelcomeEmail" 
                         formControlName="sendWelcomeEmail" 
                         class="form-checkbox me-3">
                  <label for="sendWelcomeEmail" class="text-sm text-default-700">
                    Send Welcome Email
                  </label>
                </div>

                <div *ngIf="listForm.get('settings.sendWelcomeEmail')?.value">
                  <label class="block text-sm font-medium text-default-700 mb-2">Subject Line</label>
                  <input type="text" 
                         formControlName="welcomeEmailSubject" 
                         class="form-input"
                         placeholder="Welcome to our mailing list!">
                </div>

                <div *ngIf="listForm.get('settings.sendWelcomeEmail')?.value">
                  <label class="block text-sm font-medium text-default-700 mb-2">Email Content</label>
                  <textarea formControlName="welcomeEmailContent" 
                            rows="4" 
                            class="form-input"
                            placeholder="Thank you for subscribing..."></textarea>
                </div>
              </div>
            </div>

            <!-- Compliance Settings -->
            <div>
              <h6 class="font-medium text-default-700 mb-4">Compliance & Safety</h6>
              <div class="space-y-4">
                <div class="flex items-center">
                  <input type="checkbox" 
                         id="respectUnsubscribes" 
                         formControlName="respectUnsubscribes" 
                         class="form-checkbox me-3">
                  <label for="respectUnsubscribes" class="text-sm text-default-700">
                    Respect Unsubscribes
                    <p class="text-xs text-default-500">Automatically respect global unsubscribe requests</p>
                  </label>
                </div>

                <div class="flex items-center">
                  <input type="checkbox" 
                         id="respectBounces" 
                         formControlName="respectBounces" 
                         class="form-checkbox me-3">
                  <label for="respectBounces" class="text-sm text-default-700">
                    Respect Bounces
                    <p class="text-xs text-default-500">Automatically handle bounced email addresses</p>
                  </label>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Custom Fields -->
        <div class="card">
          <div class="card-header">
            <h6 class="card-title">{{ 'CONTACTS.CUSTOM_FIELDS' | translate }}</h6>
            <button type="button" (click)="addCustomField()" class="btn btn-sm bg-transparent border border-dashed border-primary text-primary hover:bg-primary/10">
              <div class="size-4 me-1"><ng-icon name="lucidePlus"></ng-icon></div>
              {{ 'CONTACTS.ADD_FIELD' | translate }}
            </button>
          </div>
          <div class="card-body" formArrayName="customFields">
            <div *ngFor="let field of customFields.controls; let i = index" 
                 [formGroupName]="i" 
                 class="flex items-end gap-4 p-4 border border-default-200 rounded-lg mb-4">
              <div class="flex-1">
                <label class="block text-sm font-medium text-default-700 mb-2">{{ 'CONTACTS.FIELD_NAME' | translate }}</label>
                <input type="text" formControlName="name" class="form-input" placeholder="e.g., Company">
              </div>

              <div class="w-32">
                <label class="block text-sm font-medium text-default-700 mb-2">{{ 'CONTACTS.TYPE' | translate }}</label>
                <select formControlName="type" class="form-input">
                  <option *ngFor="let type of customFieldTypes" [value]="type.value">
                    {{ type.label }}
                  </option>
                </select>
              </div>

              <div class="flex-1" *ngIf="field.get('type')?.value === 'dropdown'">
                <label class="block text-sm font-medium text-default-700 mb-2">Options</label>
                <input type="text" formControlName="options" class="form-input" placeholder="Option 1, Option 2, Option 3">
              </div>

              <div class="flex-1" *ngIf="field.get('type')?.value !== 'dropdown'">
                <label class="block text-sm font-medium text-default-700 mb-2">Default Value</label>
                <input type="text" formControlName="defaultValue" class="form-input">
              </div>

              <div class="flex items-center">
                <input type="checkbox" 
                       [id]="'required-' + i"
                       formControlName="required" 
                       class="form-checkbox me-2">
                <label [for]="'required-' + i" class="text-sm text-default-700">{{ 'COMMON.REQUIRED' | translate }}</label>
              </div>

              <button type="button" 
                      (click)="removeCustomField(i)" 
                      class="btn size-7.5 bg-danger/10 text-danger hover:bg-danger hover:text-white">
                <div class="size-4"><ng-icon name="lucideTrash2"></ng-icon></div>
              </button>
            </div>

            <div *ngIf="customFields.length === 0" class="text-center text-default-500 py-8 border border-dashed border-default-200 rounded-lg">
              <div class="size-12 mx-auto mb-4 text-default-300">
                <ng-icon name="lucidePlus"></ng-icon>
              </div>
              <p>{{ 'CONTACTS.NO_CUSTOM_FIELDS' | translate }}</p>
              <p class="text-sm">{{ 'CONTACTS.ADD_FIELD_HINT' | translate }}</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Sidebar -->
      <div class="lg:col-span-1 space-y-6">
        <!-- Tags -->
        <div class="card">
          <div class="card-header">
            <h6 class="card-title">{{ 'CONTACTS.TAGS' | translate }}</h6>
            <button type="button" (click)="addTag()" class="btn btn-sm bg-transparent border border-dashed border-primary text-primary hover:bg-primary/10">
              <div class="size-4 me-1"><ng-icon name="lucidePlus"></ng-icon></div>
              {{ 'CONTACTS.ADD_TAG' | translate }}
            </button>
          </div>
          <div class="card-body" formArrayName="tags">
            <div *ngFor="let tag of tags.controls; let i = index" class="flex items-center gap-2 mb-3">
              <input type="text" 
                     [formControlName]="i" 
                     class="form-input flex-1" 
                     placeholder="Enter tag">
              <button type="button" 
                      (click)="removeTag(i)" 
                      class="btn size-7.5 bg-danger/10 text-danger hover:bg-danger hover:text-white">
                <div class="size-4"><ng-icon name="lucideX"></ng-icon></div>
              </button>
            </div>

            <div *ngIf="tags.length === 0" class="text-center text-default-500 py-6">
              <div class="size-8 mx-auto mb-2 text-default-300">
                <ng-icon name="lucideTag"></ng-icon>
              </div>
              <p class="text-sm">{{ 'CONTACTS.NO_TAGS' | translate }}</p>
            </div>
          </div>
        </div>

        <!-- List Preview -->
        <div class="card">
          <div class="card-header">
            <h6 class="card-title">{{ 'COMMON.PREVIEW' | translate }}</h6>
          </div>
          <div class="card-body">
            <div class="flex items-center gap-3 mb-4">
              <div class="w-12 h-12 rounded-lg bg-primary/10 flex items-center justify-center">
                <div class="size-6 text-primary">
                  <ng-icon [name]="getTypeIcon(listForm.get('type')?.value)"></ng-icon>
                </div>
              </div>
              <div>
                <h6 class="font-medium">{{ listForm.get('name')?.value || ('COMMON.UNTITLED' | translate) }}</h6>
                <p class="text-sm text-default-600">{{ listForm.get('type')?.value | titlecase }} List</p>
              </div>
            </div>

            <div class="space-y-3 text-sm">
              <div class="flex justify-between">
                <span class="text-default-600">{{ 'COMMON.STATUS' | translate }}:</span>
                <span class="font-medium">{{ listForm.get('status')?.value | titlecase }}</span>
              </div>
              
              <div class="flex justify-between">
                <span class="text-default-600">Double Opt-in:</span>
                <span class="font-medium">{{ listForm.get('settings.doubleOptIn')?.value ? 'Enabled' : 'Disabled' }}</span>
              </div>
              
              <div class="flex justify-between">
                <span class="text-default-600">Welcome Email:</span>
                <span class="font-medium">{{ listForm.get('settings.sendWelcomeEmail')?.value ? 'Enabled' : 'Disabled' }}</span>
              </div>
              
              <div class="flex justify-between">
                <span class="text-default-600">{{ 'CONTACTS.CUSTOM_FIELDS' | translate }}:</span>
                <span class="font-medium">{{ customFields.length }}</span>
              </div>

              <div class="flex justify-between">
                <span class="text-default-600">{{ 'CONTACTS.TAGS' | translate }}:</span>
                <span class="font-medium">{{ tags.length }}</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Save Actions -->
        <div class="card">
          <div class="card-header">
            <h6 class="card-title">{{ 'COMMON.ACTIONS' | translate }}</h6>
          </div>
          <div class="card-body space-y-3">
            <button type="submit" 
                    [disabled]="isLoading || listForm.invalid" 
                    class="btn bg-primary text-white w-full">
              <div *ngIf="isLoading" class="size-4 me-1 animate-spin">
                <ng-icon name="lucideLoader"></ng-icon>
              </div>
              <div *ngIf="!isLoading" class="size-4 me-1">
                <ng-icon name="lucideSave"></ng-icon>
              </div>
              {{ (isEditing ? 'COMMON.SAVE' : 'LISTS.CREATE_LIST') | translate }}
            </button>
            
            <button type="button" (click)="onCancel()" class="btn bg-default-100 text-default-600 w-full">
              <div class="size-4 me-1"><ng-icon name="lucideX"></ng-icon></div>
              {{ 'COMMON.CANCEL' | translate }}
            </button>
          </div>
        </div>
      </div>
    </div>
  </form>
</main>