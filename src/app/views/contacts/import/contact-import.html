<main>
  <app-page-title [title]="'CONTACTS.IMPORT_CONTACTS' | translate" [subtitle]="'CONTACTS.IMPORT_CONTACTS' | translate" />

  <!-- Progress Steps -->
  <div class="card mb-6">
    <div class="card-body">
      <div class="flex items-center justify-between">
        <div *ngFor="let step of [1, 2, 3, 4]; let i = index" class="flex items-center">
          <div [class]="'w-10 h-10 rounded-full flex items-center justify-center text-sm font-medium ' + getStepClass(step)">
            <div *ngIf="step < currentStep" class="size-5"><ng-icon name="lucideCheck"></ng-icon></div>
            <span *ngIf="step >= currentStep">{{ step }}</span>
          </div>
          <div *ngIf="i < 3" class="w-20 h-1 bg-default-200 mx-2">
            <div class="h-full bg-primary transition-all duration-300" 
                 [style.width]="step < currentStep ? '100%' : '0%'"></div>
          </div>
        </div>
      </div>
      
      <div class="grid grid-cols-4 gap-4 mt-4 text-center">
        <div>
          <div class="text-sm font-medium text-default-700">{{ 'COMMON.IMPORT' | translate }}</div>
          <div class="text-xs text-default-500">{{ 'COMMON.BROWSE' | translate }}</div>
        </div>
        <div>
          <div class="text-sm font-medium text-default-700">{{ 'CONTACTS.FIELD_NAME' | translate }}</div>
          <div class="text-xs text-default-500">{{ 'CONTACTS.FIELD_NAME' | translate }}</div>
        </div>
        <div>
          <div class="text-sm font-medium text-default-700">{{ 'COMMON.IMPORT' | translate }}</div>
          <div class="text-xs text-default-500">{{ 'COMMON.IMPORT' | translate }}</div>
        </div>
        <div>
          <div class="text-sm font-medium text-default-700">{{ 'COMMON.CLOSE' | translate }}</div>
          <div class="text-xs text-default-500">{{ 'COMMON.CLOSE' | translate }}</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Step Content -->
  <div class="card">
    <div class="card-header">
      <h6 class="card-title">Step {{ currentStep }} of {{ totalSteps }}</h6>
      <button (click)="goBackToContacts()" class="btn btn-sm bg-default-100 text-default-600">
        <div class="size-4 me-1"><ng-icon name="lucideArrowLeft"></ng-icon></div>
        {{ 'COMMON.BACK' | translate }}
      </button>
    </div>

    <div class="card-body">
      <!-- Step 1: File Upload -->
      <div *ngIf="currentStep === 1">
        <h6 class="text-lg font-semibold mb-4">{{ 'COMMON.IMPORT' | translate }} CSV</h6>
        
        <div class="border-2 border-dashed border-default-300 rounded-lg p-8 text-center">
          <input type="file" 
                 id="csvFile" 
                 accept=".csv" 
                 (change)="onFileSelected($event)" 
                 class="hidden">
          
          <div *ngIf="!uploadedFile">
            <div class="size-12 mx-auto mb-4 text-default-400">
              <ng-icon name="lucideUpload"></ng-icon>
            </div>
            <h6 class="text-lg font-medium mb-2">{{ 'COMMON.BROWSE' | translate }} CSV</h6>
            <p class="text-default-600 mb-4">{{ 'CONTACTS.IMPORT_CONTACTS' | translate }}</p>
            <label for="csvFile" class="btn bg-primary text-white cursor-pointer">
              <div class="size-4 me-1"><ng-icon name="lucideUpload"></ng-icon></div>
              {{ 'COMMON.BROWSE' | translate }}
            </label>
          </div>

          <div *ngIf="uploadedFile" class="text-success">
            <div class="size-12 mx-auto mb-4"><ng-icon name="lucideCheck"></ng-icon></div>
            <h6 class="text-lg font-medium mb-2">{{ 'MESSAGES.SAVE_SUCCESS' | translate }}</h6>
            <p class="mb-4">{{ uploadedFile.name }} ({{ (uploadedFile.size / 1024) | number:'1.0-1' }} KB)</p>
            <label for="csvFile" class="btn bg-default-100 text-default-600">
              <div class="size-4 me-1"><ng-icon name="lucideRefreshCw"></ng-icon></div>
              {{ 'COMMON.BROWSE' | translate }}
            </label>
          </div>
        </div>

        <div class="mt-6">
          <h6 class="font-medium mb-3">CSV</h6>
          <ul class="list-disc list-inside space-y-2 text-sm text-default-600">
            <li>CSV (.csv)</li>
            <li>{{ 'COMMON.EMAIL' | translate }}</li>
            <li>{{ 'COMMON.EMAIL' | translate }}</li>
            <li>10MB</li>
            <li>UTF-8</li>
          </ul>
        </div>
      </div>

      <!-- Step 2: Field Mapping -->
      <div *ngIf="currentStep === 2">
        <h6 class="text-lg font-semibold mb-4">{{ 'CONTACTS.FIELD_NAME' | translate }}</h6>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <!-- Field Mappings -->
          <div>
            <h6 class="font-medium mb-3">{{ 'CONTACTS.FIELD_NAME' | translate }}</h6>
            <div class="space-y-4">
              <div *ngFor="let field of contactFields" class="flex items-center gap-4">
                <div class="w-32">
                  <label class="text-sm font-medium text-default-700">
                    {{ field.label }}
                    <span *ngIf="field.required" class="text-danger">*</span>
                  </label>
                </div>
                <div class="flex-1">
                  <select [value]="getMappingValue(field.key)"
                          (change)="updateMapping(field.key, $event)"
                          class="form-input w-full"
                          [class.border-danger]="isMappingRequired(field)">
                    <option value="">{{ 'CONTACTS.SELECT_TIMEZONE' | translate }}</option>
                    <option *ngFor="let header of csvHeaders" [value]="header">{{ header }}</option>
                  </select>
                </div>
              </div>
            </div>

            <div *ngIf="!validateMappings()" class="p-4 bg-danger/10 border border-danger/20 rounded-lg mt-4">
              <div class="flex items-center gap-2">
                <div class="size-5 text-danger"><ng-icon name="lucideAlertCircle"></ng-icon></div>
                <span class="text-sm text-danger font-medium">{{ 'COMMON.EMAIL' | translate }}</span>
              </div>
            </div>
          </div>

          <!-- CSV Preview -->
          <div>
            <h6 class="font-medium mb-3">CSV {{ 'COMMON.VIEW' | translate }}</h6>
            <div class="overflow-x-auto border border-default-200 rounded-lg">
              <table class="min-w-full divide-y divide-default-200">
                <thead class="bg-default-50">
                  <tr>
                    <th *ngFor="let header of csvHeaders" class="px-3 py-2 text-left text-xs font-medium text-default-700 uppercase tracking-wider">
                      {{ header }}
                    </th>
                  </tr>
                </thead>
                <tbody class="bg-white divide-y divide-default-200">
                  <tr *ngFor="let row of csvPreviewData">
                    <td *ngFor="let cell of row" class="px-3 py-2 whitespace-nowrap text-sm text-default-600">
                      {{ cell || '-' }}
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            <p class="text-xs text-default-500 mt-2">{{ 'COMMON.SHOWING' | translate }} 5</p>
          </div>
        </div>
      </div>

      <!-- Step 3: Import Settings -->
      <div *ngIf="currentStep === 3">
        <h6 class="text-lg font-semibold mb-4">{{ 'COMMON.IMPORT' | translate }}</h6>
        
        <form [formGroup]="importForm" class="space-y-6">
          <div>
            <label class="block text-sm font-medium text-default-700 mb-2">
              {{ 'CAMPAIGNS.SELECT_LIST' | translate }} <span class="text-danger">*</span>
            </label>
            <select formControlName="selectedList" class="form-input w-full">
              <option value="">{{ 'CAMPAIGNS.SELECT_LIST' | translate }}</option>
              <option *ngFor="let list of availableLists$ | async" [value]="list.id">
                {{ list.name }} ({{ list.subscriberCount }} {{ 'CAMPAIGNS.SUBSCRIBERS' | translate }})
              </option>
            </select>
          </div>

          <div class="space-y-4">
            <div class="flex items-center">
              <input type="checkbox"
                     id="updateExisting"
                     formControlName="updateExisting"
                     class="form-checkbox me-3">
              <label for="updateExisting" class="text-sm text-default-700">
                {{ 'CONTACTS.UPDATE_CONTACT' | translate }}
              </label>
            </div>

            <div class="flex items-center">
              <input type="checkbox"
                     id="sendWelcomeEmail"
                     formControlName="sendWelcomeEmail"
                     class="form-checkbox me-3">
              <label for="sendWelcomeEmail" class="text-sm text-default-700">
                {{ 'COMMON.SEND' | translate }}
              </label>
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-default-700 mb-2">{{ 'CONTACTS.ADD_TAG' | translate }}</label>
            <input type="text"
                   formControlName="tagToAdd"
                   placeholder="imported-2024"
                   class="form-input">
            <p class="text-xs text-default-500 mt-1">{{ 'CONTACTS.ADD_TAG' | translate }}</p>
          </div>
        </form>

        <div *ngIf="!isImporting" class="mt-6">
          <button (click)="startImport()"
                  [disabled]="!importForm.valid || !validateMappings()"
                  class="btn bg-primary text-white w-full">
            <div class="size-4 me-1"><ng-icon name="lucidePlay"></ng-icon></div>
            {{ 'COMMON.IMPORT' | translate }}
          </button>
        </div>

        <div *ngIf="isImporting" class="mt-6 text-center">
          <div class="size-12 mx-auto mb-4 text-primary animate-spin">
            <ng-icon name="lucideLoader"></ng-icon>
          </div>
          <p class="text-default-600">{{ 'COMMON.LOADING' | translate }}</p>
        </div>
      </div>

      <!-- Step 4: Results -->
      <div *ngIf="currentStep === 4 && importResult">
        <h6 class="text-lg font-semibold mb-4">{{ 'COMMON.IMPORT' | translate }}</h6>
        
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
          <div class="card bg-primary/5 border-primary/20">
            <div class="card-body text-center p-6">
              <div class="text-2xl font-bold text-primary">{{ importResult.totalRecords }}</div>
              <div class="text-sm text-default-600">{{ 'CAMPAIGNS.TOTAL' | translate }}</div>
            </div>
          </div>

          <div class="card bg-success/5 border-success/20">
            <div class="card-body text-center p-6">
              <div class="text-2xl font-bold text-success">{{ importResult.successfulImports }}</div>
              <div class="text-sm text-default-600">{{ 'MESSAGES.SAVE_SUCCESS' | translate }}</div>
            </div>
          </div>

          <div class="card bg-warning/5 border-warning/20">
            <div class="card-body text-center p-6">
              <div class="text-2xl font-bold text-warning">{{ importResult.duplicateContacts }}</div>
              <div class="text-sm text-default-600">{{ 'COMMON.DUPLICATE' | translate }}</div>
            </div>
          </div>

          <div class="card bg-danger/5 border-danger/20">
            <div class="card-body text-center p-6">
              <div class="text-2xl font-bold text-danger">{{ importResult.failedImports }}</div>
              <div class="text-sm text-default-600">{{ 'MESSAGES.SEND_ERROR' | translate }}</div>
            </div>
          </div>
        </div>

        <div *ngIf="importResult.errors.length > 0" class="mb-6">
          <div class="flex items-center justify-between mb-3">
            <h6 class="font-medium text-danger">{{ 'MESSAGES.SEND_ERROR' | translate }}</h6>
            <button (click)="downloadErrorReport()" class="btn btn-sm bg-transparent border border-dashed border-primary text-primary hover:bg-primary/10">
              <div class="size-4 me-1"><ng-icon name="lucideDownload"></ng-icon></div>
              {{ 'SETTINGS.DOWNLOAD' | translate }}
            </button>
          </div>
          
          <div class="overflow-x-auto border border-default-200 rounded-lg">
            <table class="min-w-full divide-y divide-default-200">
              <thead class="bg-default-50">
                <tr>
                  <th class="px-4 py-3 text-left text-xs font-medium text-default-700 uppercase tracking-wider">Row</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-default-700 uppercase tracking-wider">Email</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-default-700 uppercase tracking-wider">Error</th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-default-200">
                <tr *ngFor="let error of importResult.errors.slice(0, 10)">
                  <td class="px-4 py-3 whitespace-nowrap text-sm text-default-900">{{ error.row }}</td>
                  <td class="px-4 py-3 whitespace-nowrap text-sm text-default-600">{{ error.email }}</td>
                  <td class="px-4 py-3 whitespace-nowrap text-sm text-danger">{{ error.error }}</td>
                </tr>
              </tbody>
            </table>
          </div>
          
          <p *ngIf="importResult.errors.length > 10" class="text-sm text-default-500 mt-2">
            {{ 'COMMON.SHOWING' | translate }} 10
          </p>
        </div>

        <div class="flex gap-3">
          <button (click)="finishImport()" class="btn bg-primary text-white">
            <div class="size-4 me-1"><ng-icon name="lucideCheck"></ng-icon></div>
            {{ 'NAV.CONTACTS' | translate }}
          </button>

          <button (click)="currentStep = 1; uploadedFile = null; importResult = null" class="btn bg-default-100 text-default-600">
            <div class="size-4 me-1"><ng-icon name="lucideRefreshCw"></ng-icon></div>
            {{ 'COMMON.IMPORT' | translate }}
          </button>
        </div>
      </div>
    </div>

    <!-- Navigation -->
    <div *ngIf="currentStep < 4" class="card-footer">
      <div class="flex justify-between">
        <button (click)="previousStep()"
                [disabled]="currentStep === 1"
                class="btn bg-default-100 text-default-600"
                [class.opacity-50]="currentStep === 1">
          <div class="size-4 me-1"><ng-icon name="lucideArrowLeft"></ng-icon></div>
          {{ 'COMMON.PREVIOUS' | translate }}
        </button>

        <button (click)="nextStep()"
                [disabled]="(currentStep === 1 && !uploadedFile) || (currentStep === 2 && !validateMappings())"
                class="btn bg-primary text-white"
                [class.opacity-50]="(currentStep === 1 && !uploadedFile) || (currentStep === 2 && !validateMappings())">
          {{ 'COMMON.NEXT' | translate }}
          <div class="size-4 ms-1"><ng-icon name="lucideArrowRight"></ng-icon></div>
        </button>
      </div>
    </div>
  </div>
</main>